<html>
    <head>
        <base target="_top">
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <title>Freight Flows</title>
        
        <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico">
    
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.15.0/proj4.js" integrity="sha512-zlBm5j/0UjgCzqBVLkATd/2b9Yun4SzATXJ7v1T2KfjmP0iw8FUcG5mPD60SrdxU+tRkACm3IQRq55pEkp9Qow==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
        <style>
            html, body {
                height: 100%;
                margin: 0;
            }
            .leaflet-container {
                height: 400px;
                width: 600px;
                max-width: 100%;
                max-height: 100%;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script>
            var osgb = "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs"
            var wgs84 = "+proj=longlat +datum=WGS84 +no_defs"
            function mapOSGB(pos) {
                var out = proj4(osgb, wgs84, pos)
                return [out[1], out[0]]
            }

            //proj4.defs("EPSG:27700","+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +nadgrids=uk_os_OSTN15_NTv2_OSGBtoETRS.tif +units=m +no_defs +type=crs");
            var proj = mapOSGB([627419, 234595])
            var proj2 = mapOSGB([629156, 233475])

            const map = L.map('map').setView(proj, 13);

            const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            function interpolate(color1, color2, percent) {
                // Convert the hex colors to RGB values
                const r1 = parseInt(color1.substring(1, 3), 16);
                const g1 = parseInt(color1.substring(3, 5), 16);
                const b1 = parseInt(color1.substring(5, 7), 16);

                const r2 = parseInt(color2.substring(1, 3), 16);
                const g2 = parseInt(color2.substring(3, 5), 16);
                const b2 = parseInt(color2.substring(5, 7), 16);

                // Interpolate the RGB values
                const r = Math.round(r1 + (r2 - r1) * percent);
                const g = Math.round(g1 + (g2 - g1) * percent);
                const b = Math.round(b1 + (b2 - b1) * percent);

                // Convert the interpolated RGB values back to a hex color
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            }

            //L.marker([proj[1], proj[0]]).addTo(map)
            //L.polyline([proj, proj2], {color: "red"}).addTo(map);

            var schedules = []
            var tiploc = {}
            var routes = {}

            function generate_lines() {
                console.log("generating lines")
                for (const [loc, obj] of Object.entries(routes)) {
                    for (const [next_loc, count] of Object.entries(obj)) {
                        L.polyline([tiploc[loc].pos, tiploc[next_loc].pos], {color: interpolate("#FFFF00", "#FF0000", count / 100.0)}).addTo(map);
                    }
                }
                console.log("finished generating lines")
            }

            function count_schedules() {
                console.log("counting schedules")
                for (element of schedules) {
                    var obj = JSON.parse(element).JsonScheduleV1
                    var path = obj.schedule_segment.schedule_location
                    if (!path) continue

                    for (let i = 0; i < path.length - 1; i++) {
                        var loc = path[i]
                        var next_loc = path[i+1]
                        count_path(loc.tiploc_code, next_loc.tiploc_code)
                    }
                }
                console.log("finished counting schedules")
                generate_lines()
            }

            function count_path(start, end) { // tiploc codes
                if (start == end) return // wouldnt make sense...
                if (start > end) { // keep consistent order
                    var temp = start
                    start = end
                    end = temp
                }

                if (routes[start]) {
                    if (routes[start][end]) {
                        routes[start][end] += 1
                    } else {
                        routes[start][end] = 1
                    }
                } else {
                    routes[start] = {
                        [end]: 1
                    }
                }
            }

            function fetch_tiploc() {
                console.log("Fetching tiploc")
                fetch("https://raw.githubusercontent.com/saismee/train-density-map/refs/heads/master/data/tiploc")
                .then(res => res.text())
                .then(text => {
                    //console.log(text)
                    var data = JSON.parse(text)

                    console.log("tiploc entries: " + data.Tiplocs.length)
                    for (element of data.Tiplocs) {
                        if (tiploc[element.Tiploc] === undefined) continue
                        var tiplocEntry = {
                            pos: [
                                element.Latitude,
                                element.Longitude
                            ],
                            name: (element.Name || "unnamed") + "(" + element.Tiploc + ")"
                        }
                        //L.marker(tiplocEntry.pos, {title: tiplocEntry.name}).addTo(map)

                        tiploc[element.Tiploc] = tiplocEntry
                    }
                    console.log("Fetched tiploc")

                    count_schedules()
                })
                .catch(e => console.error(e))
            }

            function fetch_schedules() {
                console.log("Fetching toc-full")
                fetch("https://media.githubusercontent.com/media/saismee/train-density-map/master/data/toc-full")
                .then(res => res.text())
                .then(text => {
                    var data = text.split(/\r?\n|\r|\n/g)
                    console.log(data)

                    console.log("entries: " + data.length)
                    for (element of data) {
                        if (element.startsWith("{\"JsonScheduleV1")) {
                            schedules.push(element)
                        } else if (element.startsWith("{\"TiplocV1")) {
                            var obj = JSON.parse(element)
                            tiploc[obj.TiplocV1.tiploc_code] = []
                            //console.log(obj.TiplocV1.tiploc_code)
                        }
                    }
                    console.log("schedules: " + schedules.length)
                    console.log("tiploc codes: " + Object.keys(tiploc).length)
                    console.log("Fetched toc-full")

                    fetch_tiploc()
                })
                .catch(e => console.error(e))
            }

            fetch_schedules()       
        </script>
    </body>
</html>